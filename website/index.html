<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en" lang="en">
<head>
<style>  
    div.padded {  
      padding-top: 0px;  
      padding-right: 100px;  
      padding-bottom: 0.25in;  
      padding-left: 100px;  
    }  
  </style> 
<title>Chuqian Li  |  CS 184</title>
<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<link rel="stylesheet" type="text/css" href="style.css" media="screen" />
</head>
<body>
<br />
<h1 align="middle">Assignment 3: PathTracer</h1>
    <h2 align="middle">Chuqian</h2>

    <div class="padded">
        <p>In this assignment, I implemented various techniques used in ray tracing. The first two parts mainly deal with intersecting rays with objects and speeding up intersection using Bounding Volume Hierarchy. The third and fourth part implements tracing and sample from the light source and give me the power to render the actual light and shadows instead of just the shapes. Direct illuminance traces the light that directly come from the light source. Indirect illumincance also takes into account of light rays that bounce multiple times before hitting the object. The last part defines Bidirectional Scattering Distribution Function(bsdf) for mirror and glass materials. We render scenes of various shapes and materials in the cornell box to test and compare reflection and refraction effects of the ray tracer.</p>

    <h2 align="middle">Part 1: Ray Generation and Intersection</h2>
        <h3>Ray Generation</h3>
        <!-- <p>If num_samples == 1, the sample(x,y) passed the center of pixel (origin.x+0.5, origin.y+0.5)</p>
        <p>If num_samples > 1, loop num_samples times. In each iteration, call gridSampler->get_sample to get a random Vector2D in range of [0,1]^2. Add this to (origin.x, origin.y) to get sample(x,y).</p>
        <p>For each sample (x, y), divide by sampleBuffer.w and sampleBuffer.h to sacle it down to [0,1].</p>
        <p>For each scaled sample, call camera->generate_ray. Set depth of the result ray as max_ray_depth. Average over the results of calling trace_ray on the generated rays to get the result spectrum.</p> -->
        <p>We want a mapping that converts input (0,0) into (-tan(radians(hFov)*.5), -tan(radians(vFov)*.5)) and (1,1) into ( tan(radians(hFov)*.5),  tan(radians(vFov)*.5) on sensor plane. This is a easy linear transformation :</p>
        <p align="middle"><pre align="middle">sensorX = -tan(radians(hFov)*.5) + x*2*(tan(radians(hFov)*.5))</pre></p>
        <p align="middle"><pre align="middle">sensorY = -tan(radians(vFov)*.5) + y*2*(tan(radians(vFov)*.5))</pre></p>
        <p>Apply c2w to (sensorX, sensorY, -1) to get world coordinate, which is also the direction of the generated ray.</p>
        <p>Set the origin of the ray to camera postion, min_t to nClip, max_t to fClip.</p>
        <h3>Primitive intersection</h3>
        <p>After sample rays are generated, we follow the rays to find primitives that the ray hits. The two primitives are triangles and spheres. There are two versions of intersect function. THe first one is used to find any intersection. The second one is used to find the first intersection and return the intersection infomations like normal and intersected primites.</p>
        <h4>Triangle Intersection</h4>
        <p>I implemented Moller Trumbore Algorithm to find the t value on the intersected ray and barycentric coordinates of the intersection, the latter of which is used to calculate the normal of the intersection point.</p>
        <p>Define E1 = P2 - P1, E2 = P3 - P1 (P1,P2,P3 are three vertices of triangle)</p>
        <p>Define S = origin of ray - P1</p>
        <p>Define S1 = the dot product of the direction of ray and E2</p>
        <p>Define S2 = the dot product of S and E1</p>
        <p>t = (dot product of S2 and E2)/(dot product of S1 and E1)</p>
        <p>b2 = (dot product of S1 and S)/(dot product of S1 and E1)</p>
        <p>b3 = (dot product of S2 and D)/(dot product of S1 and E1)</p>
        <p>if any of b2, b3 is negative or (b2+b3) > 1, the intersection is outside the triangle. <p>
        <p>Make sure the result t is within range of ray's min_t and max_t</p>
        <p>For the second version of intersection, interpolated normal = (1-b2-b3)*n1+b2*n2+b3*n3</p>
        
        <h4>Sphere Intersection</h4>
        <p>Plug o = ray's origin, d = ray's direction, c = circle's origin and R = circle's radius into the following formula.</p>
        <p>If b^2-4a < -Epsilon, no intersection</p>
        <p>Set the smaller t that's not negative and within range of min_t and max_t as intersection.<p>
        <p align="middle"><pre align="middle"><img src="images/formula1.png" width=400px/></pre></p>
        <h3>Normal shading on small files:</h3>
        <div align="center">
            <table style="width=100%">
                <tr>
                    <td align="middle">
                    <img src="images/p1/CBempty_10.79.png" width="480px" />
                    <figcaption align="middle">CBempty: 4.5s to render</figcaption>
                </tr>
                <tr>
                    <td align="middle">
                    <img src="images/p1/CBspheres_lambertian_12.98.png" width="480px" />
                    <figcaption align="middle">CBspheres_lambertian: 5.8s to render</figcaption>
                </tr>
                <tr>
                    <td align="middle">
                    <img src="images/p1/CBgems_129.49.png" width="480px" />
                    <figcaption align="middle">CBgems:76.3s to render</figcaption>
                </tr>
            </table>
        </div>

    <h2 align="middle">Part 2: Bounding Volume Hierarchy</h2>
        <p>The previous part a specific ray with primitives by looping over each primitive. In order to speed up this, we use bounding volumn hiearching which store primitives in recursive bounding volumns and find intersections using divide and conquer.</p>
        <h3>BVH construction</h3>
        
        <div align="center">
            <table style="width=100%">
                <tr>
                    <td align="middle">
                    <img src="images/p2/bunny.png" width="480px" />
                    <figcaption align="middle"></figcaption>


                </tr>

            </table>
        </div>

        <p>Here is an example of how to include a simple formula:</p>
        <p align="middle"><pre align="middle">a^2 + b^2 = c^2</pre></p>
        <p>or, alternatively, you can include an SVG image of a LaTex formula.</p>
        <p>This time it's your job to copy-paste in the rest of the sections :)</p>


    <h2 align="middle">Part 3: Direct Illumination</h2>
    <h2 align="middle">Part 4: Indirect Illumination</h2>
    <h2 align="middle">Part 5: Materials</h2>

<!-- 
==================small======================
[PathTracer] Input scene file: ../dae/sky/CBspheres_lambertian.dae
[PathTracer] Collecting primitives... Done! (0.0000 sec)
[PathTracer] Building BVH from 14 primitives... Done! (0.0000 sec)
[PathTracer] Rendering... 100%! (6.1243s)
[PathTracer] BVH traced 10878092 rays.
[PathTracer] Averaged 7.000989 intersection tests per ray.


[PathTracer] Input scene file: ../dae/sky/CBgems.dae
[PathTracer] Collecting primitives... Done! (0.0001 sec)
[PathTracer] Building BVH from 252 primitives... Done! (0.0015 sec)
[PathTracer] Rendering... 100%! (10.2191s)
[PathTracer] BVH traced 10969792 rays.
[PathTracer] Averaged 8.590604 intersection tests per ray.

==================big=======================

[PathTracer] Input scene file: ../dae/sky/CBbunny.dae
[PathTracer] Collecting primitives... Done! (0.0041 sec)
[PathTracer] Building BVH from 28588 primitives... Done! (0.2027 sec)
[PathTracer] Rendering... 100%! (12.7242s)
[PathTracer] BVH traced 11000160 rays.
[PathTracer] Averaged 9.477100 intersection tests per ray.

[PathTracer] Input scene file: ../dae/meshedit/maxplanck.dae
[PathTracer] Collecting primitives... Done! (0.0068 sec)
[PathTracer] Building BVH from 50801 primitives... Done! (0.3255 sec)
[PathTracer] Rendering... 100%! (17.1707s)
[PathTracer] BVH traced 11012386 rays.
[PathTracer] Averaged 10.386691 intersection tests per ray.


[PathTracer] Input scene file: ../dae/meshedit/beast.dae
[PathTracer] Collecting primitives... Done! (0.0063 sec)
[PathTracer] Building BVH from 64618 primitives... Done! (0.4427 sec)
[PathTracer] Rendering... 100%! (21.3276s)
[PathTracer] BVH traced 38501542 rays.
[PathTracer] Averaged 2.114157 intersection tests per ray.


[PathTracer] Input scene file: ../dae/sky/CBdragon.dae
[PathTracer] Collecting primitives... Done! (0.0141 sec)
[PathTracer] Building BVH from 100012 primitives... Done! (0.8700 sec)
[PathTracer] Rendering... 100%! (30.4459s)
[PathTracer] BVH traced 38541124 rays.
[PathTracer] Averaged 3.806001 intersection tests per ray.

[PathTracer] Input scene file: ../dae/sky/CBdragon.dae
[PathTracer] Collecting primitives... Done! (0.0147 sec)
[PathTracer] Building BVH from 100012 primitives... Done! (0.8697 sec)
[PathTracer] Rendering... 100%! (13.9356s)
[PathTracer] BVH traced 10996940 rays.
[PathTracer] Averaged 8.737358 intersection tests per ray.


[PathTracer] Input scene file: ../dae/sky/blob.dae
[PathTracer] Collecting primitives... Done! (0.0290 sec)
[PathTracer] Building BVH from 196608 primitives... Done! (1.4620 sec)
[PathTracer] Rendering... 100%! (20.3379s)
[PathTracer] BVH traced 11015529 rays.
[PathTracer] Averaged 11.954795 intersection tests per ray.

[PathTracer] Input scene file: ../dae/keenan/building.dae
[PathTracer] Collecting primitives... Done! (0.0034 sec)
[PathTracer] Building BVH from 39506 primitives... Done! (0.2678 sec)
[PathTracer] Rendering... 100%! (39.0777s)
[PathTracer] BVH traced 38539101 rays.
[PathTracer] Averaged 6.043608 intersection tests per ray.
 
p4:
./pathtracer -t 8 -s 64 -l 16 -m 5 -r 480 360 -f bunny_indirect.png ../dae/sky/CBbunny.dae
-->

    <h2 align="middle">A Few Notes On Webpages</h2>
        <p>Here are a few problems students have encountered in the past. You will probably encounter these problems at some point, so don't wait until right before the deadline to check that everything is working. Test your website on the instructional machines early!</p>
        <ul>
        <li>Your main report page should be called index.html.</li>
        <li>Be sure to include and turn in all of the other files (such as images) that are linked in your report!</li>
        <li>Use only <em>relative</em> paths to files, such as <pre>"./images/image.jpg"</pre>
        Do <em>NOT</em> use absolute paths, such as <pre>"/Users/student/Desktop/image.jpg"</pre></li>
        <li>Pay close attention to your filename extensions. Remember that on UNIX systems (such as the instructional machines), capitalization matters. <pre>.png != .jpeg != .jpg != .JPG</pre>
        <li>Be sure to adjust the permissions on your files so that they are world readable. For more information on this please see this tutorial: <a href="http://www.grymoire.com/Unix/Permissions.html">http://www.grymoire.com/Unix/Permissions.html</a></li>
        <li>And again, test your website on the instructional machines early!</li>
</div>
</body>
</html>




